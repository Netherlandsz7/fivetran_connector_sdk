name: Run Fivetran Debug

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  fivetran-debug:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fivetran_connector_sdk

      - name: Run Fivetran Debug
        env:
          TEST_KEY: ${{ secrets.SATVIK_API_TEST }}
        working-directory: examples/quickstart_examples/hello  
        run: |
          set -e
          echo "Starting Fivetran deployment"
          python3 -u -c "
          import subprocess
          import sys
          
          print('Running fivetran deploy...', flush=True)
          
          proc = subprocess.Popen([
              'fivetran', 'deploy',
              '--api-key', '${TEST_KEY}',
              '--destination', 'Testing',
              '--connection', 'satvik_csdk_test_github_action',
              '--python-version', '3.11.11',
              '--force'
          ], stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)
          
          # Print output line by line in real-time
          for line in proc.stdout:
              print(line, end='', flush=True)
          
          proc.stdout.close()
          return_code = proc.wait()
          
          if return_code != 0:
              print(f'Deploy failed with exit code {return_code}', file=sys.stderr)
              sys.exit(return_code)
          else:
              print('Deploy succeeded.', flush=True)
          "
